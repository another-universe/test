Начало работы над функционалом цитат.

Создана миграция и модель для цитат.
Реализованы связи между пользователем и цитатой.

Добавлена политика и контроллер. Пока без фактической реализации. Реализация будет в следующих сериях.

Но чуть остановимся на политике.
Политикой мы фактически проверяем только два маршрута: edit и update. Ну, для апишки будет вообще 1 маршрут.
Можно было бы зарегистрировать гейт вместо политики. Но я предпочёл политику. Из соображений расширяемости.
Предположим, нам чуть позже нужно будет добавить проверки на другие маршруты: бесплатные пользователи могут добавлять 3 цитаты в неделю, а платные - без ограничений.
И нам нужно будет либо регистрировать дополнительные гейты, либо, что более правильно, преобразовывать это всё дело в класс политики.
Так что пускай сразу будет политика.
Но при этом, я убрал из политики все ненужные проверки.
Т.е. те же create и store методы контроллера нам нет смысла закрывать политикой, т.к. они и так закрыты аутентификацией. Т.е. если неаутентифицированный пользователь попытается добавить цитату, то дело до политики даже не дойдёт.
А аутентифицированный пользователь у нас заведомо проходит проверку.

Хотел бы вернуться к миграции.
У нас там было требование уникальности цитат.
Я немного посамовольничал и сделал составной уникальный индекс по тексту цитаты и языку, а не просто по тексту.
Чисто технически нам никто не запрещает добавить цитату на русском на en-версии и наоборот.
Не, ну мы то исходим из того, что у нас сознательные пользователи и делать они такого не будут))) Но тем не менее.
Просто прикинем ситуацию. Несознательный пользователь зашёл на en-версию и добавил какую-то цитату.
Потом заходит пользователь на ru-версию и пытается добавить эту же цитату.
Мы ему говорим что такая цитата уже есть.
Пользователю становится интересно кто её добавил.
Он просматривает все 5500 страниц цитат, которые отображаются на ru-версии и не находит эту цитату!
Но приложение упорно продолжает не пропускать её добавление.
Пользователь решает что у нас глючный сайт и уходит к конкурентам.
Мы теряем пользователей. Инвестор теряет деньги. Сайт закрывается и мы остаёмся без работы.
Так что я просто выбрал меньшее из зол.

Да и вообще, использовать уникальный индекс для данной цели - занятие крайне сомнительное.
Индексы (не полнотекстовые) на больших текстовых столбцах - в принципе не очень хорошо.
Хотя, если мы выполним "show create table quotes;", мы увидим заветные слова "using hash". Так что в данном случае индекс будет строиться по хешу строки, а не по строке, как таковой. Так что это пол беды.
Но дело немного в другом. Просто уникальный индекс в данном случае не гарантирует никакой уникальности.
Случайно пропущенная запятая, или специально поставленный лишний пробел между словами, полностью ломает всю нашу уникальность и допускает возможность добавления дублей.

Но у нас таки тестовое, так что пускай будет так. Просто обратил внимание на минусы подхода.
